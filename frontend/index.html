<!DOCTYPE html>
<html>
<body>
  <div style = "display:flex;flex-direction: column;width:80vw;margin:auto;height:80vh"

<h1>Image Upload</h1>

<input type="file" id="imageUpload" accept="image/*" onchange="previewFile()">

<img id="preview" width="200">

<h3 id = "numberOfFiles"></h3>
<h3 id = "totalFileSize"></h3>
<h3 id = "imageFileSize"></h3>
<h3 id = "percentage"></h3>

<meter id="range" min="0" max="35000000000" value="0"></meter>

<button onclick="uploadImage()" style = "margin-top:2rem">Upload</button>
</div>

<script>
window.onload = function() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/api/stats', true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      var data = JSON.parse(xhr.responseText);
        document.getElementById('numberOfFiles').innerHTML = 'Number of files: ' + data.numberOfImages;
        let totalSize = data.totalSize;
        if (totalSize > 1000000000) {
          totalSize = totalSize / 1000000000;
          totalSize = totalSize.toFixed(3);
          totalSize = totalSize + ' GB';
        }
        else if (totalSize > 1000000) {
          totalSize = totalSize / 1000000;
          totalSize = totalSize.toFixed(3);
          totalSize = totalSize + ' MB';
        } else if (totalSize > 1000) {
          totalSize = totalSize / 1000;
          totalSize = totalSize.toFixed(3);
          totalSize = totalSize + ' KB';
        } else {
          totalSize = totalSize + ' B';
        }
        document.getElementById('totalFileSize').innerHTML = 'Total file size: ' + totalSize;
        let imageSize = totalSize - (3522714 * 1024);
        if (imageSize > 1000000000) {
          imageSize = imageSize / 1000000000;
          imageSize = imageSize.toFixed(3);
          imageSize = imageSize + ' GB';
        }
        else if (imageSize > 1000000) {
          imageSize = imageSize / 1000000;
          imageSize = imageSize.toFixed(3);
          imageSize = imageSize + ' MB';
        } else if (imageSize > 1000) {
          imageSize = imageSize / 1000;
          imageSize = imageSize.toFixed(3);
          imageSize = imageSize + ' KB';
        } else {
          imageSize = imageSize + ' B';
        }
        document.getElementById('imageFileSize').innerHTML = 'Image file size: ' + imageSize;
        let percentage = (imageSize / totalSize) * 100;
        percentage = percentage.toFixed(3);
        document.getElementById('percentage').innerHTML = 'Storage: ' + percentage + '%';
        document.getElementById('range').value = data.totalSize;
    } else {
      console.error('An error occurred: ' + xhr.status);
    }
  };
  xhr.send();
};


  function previewFile() {
    var preview = document.getElementById('preview');
    var file    = document.querySelector('input[type=file]').files[0];
    var reader  = new FileReader();

    reader.onloadend = function () {
      preview.src = reader.result;
    }

    if (file) {
      reader.readAsDataURL(file);
    } else {
      preview.src = "";
    }
  }

  function uploadImage() {
    var input = document.getElementById('imageUpload');
    var file = input.files[0];
    var formData = new FormData();
    formData.append('file', file);

    fetch('/api/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.filename) {
            window.location.href = '/uploads/' + data.filename;
        } else {
            console.error('No file uploaded');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

</script>

</body>
</html>